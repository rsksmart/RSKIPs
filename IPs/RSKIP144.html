<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title> | RSK Improvement Proposals</title>
    <meta
      property="og:title"
      content=" | RSK Improvement Proposals"
    />
    <meta name="description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />

  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="https://ips.rsk.co/IPs/RSKIP144.html" />
  <meta property="og:url" content="https://ips.rsk.co/IPs/RSKIP144.html" />
  <meta property="og:site_name" content="RSK Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "https://ips.rsk.co",
      "name": "RSK Improvement Proposals",
      "description": "RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" />
      <!-- Google Fonts -->
      <link href="https://fonts.googleapis.com/css?family=Quicksand:400,700,900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,600,700,800&display=swap" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="https://ips.rsk.co/pages/rsksmart/rskips/feed.xml" title="RSK Improvement Proposals" /><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script>
</head>
<body><header class="site-header" role="banner">
  <button id="dark-mode-toggle" class="dark-mode-toggle theme-toggle-button">
    <svg class="icon" style="width:24px;height:24px" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.1L13.73,3.13L12.38,4.26L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.33L10.24,7.36L9.19,8.23L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.93L17.93,10.24C18.6,11.15 19,12.28 19,13.5M14.6,20.08L17.37,18.93L17.13,22.28L14.6,20.08M18.93,17.38L20.08,14.61L22.28,17.15L18.93,17.38M20.08,12.42L18.94,9.64L22.28,9.88L20.08,12.42M9.63,18.93L12.4,20.08L9.87,22.27L9.63,18.93Z" />
    </svg>
  </button>


<div class="wrapper"><a class="site-title" rel="author" href="/">RSK Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link underline" href="/all.html">All</a><a class="page-link underline" href="/scalability.html">Scalability</a><a class="page-link underline" href="/security.html">Security</a><a class="page-link underline" href="/usability.html">Usability</a><a class="page-link underline" href="/fairness.html">Fairness</a><a class="page-link underline" href="/standardtrack.html">Standard Track</a></div>





      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title"></h1>
  </header>

  <div class="post-content">
    <hr />
<p>rskip: 144
title: Parallel Transaction Execution for Unitrie
description: This RSKIP describes how miners partition transactions into disjoint sets in order to be safely parallelized, and how full nodes should process transactions.
status: Accepted
purpose: Sca
author: SDL (@sergiodemianlerner)
layer: Core
complexity: 3
created: 23-OCT-2019</p>

<h1 id="abstract">Abstract</h1>

<p>This RSKIP describes how miners partition transactions into disjoint sets in order to be safely parallelized, and how full nodes should process transactions.</p>

<h1 id="motivation">Motivation</h1>

<p>Parallelizing the execution of transactions allows increasing the block gas limit without increasing the block execution time, and improves the scalability of RSK by increasing the transaction throughput.</p>

<p>Now, RSK nodes process transactions from blocks one by one, in the specified order. This is because the final state after processing two transactions when applied in different order may differ. However most transactions do not use the same keys of the state and therefore they could be parallelized without interference.</p>

<p>There are several obstacles to parallelization. <a href="RSKIP02">RSKIP02</a> and <a href="RSKIP04">RSKIP04</a> explore different methods that worked prior the implementation of the Unitrie. This RSKIP proposes using a runtime method to partition the transaction set into threads similar to RSKIP04 but tailored for the Unitrie.</p>

<p>Miners are forced to serialize transaction execution to create blocks. At the same time they execute the transactions, they discover runtime key-access overlaps between transactions and build an execution plan that is included in the block header. For a simpler overlap detection and to prevent DoS attacks, an additional part is added including all the transactions that could not be parallelized, that is executed after the execution of the parallel parts is completed. Once all transactions have been processed, the partition is created along with a schedule that determines which transactions belong in each part.</p>

<p>Full nodes can use this schedule to split the transaction set and parallelize execution.</p>

<h1 id="specification">Specification</h1>

<p>Transactions in a block are divided into <code class="language-plaintext highlighter-rouge">N+1</code> sublists, where the first <code class="language-plaintext highlighter-rouge">N</code> sublists are executed in parallel and the last sublist is executed after the others. We refer to the first <code class="language-plaintext highlighter-rouge">N</code> sublists as the <em>parallel sublists</em> and to the last partition as the <em>sequential sublist</em>.</p>

<p align="middle">
  <img src="./RSKIP144/schedule.png" alt="Schedule" /><br />
  <em>Block with 3+1 sublists. The 3 sublists are run in parallel, and after completion of all, the 4th sublist is run.</em>
</p>

<h2 id="new-block-gas-limits">New block gas limits</h2>

<p>Each sublist has its own gas limit value. The block <code class="language-plaintext highlighter-rouge">gasLimit</code> constant is replaced for two new constants:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">parallelSublistGasLimit = 3.400.000</code> is the gas limit for each <em>parallel sublists</em></li>
  <li><code class="language-plaintext highlighter-rouge">sequentialSublistGasLimit = 3.400.000</code> is the gas limit for the <em>sequential sublist</em></li>
</ul>

<p>The gas used in each sublist must be treated similar to the how the gas limit was treated. The sum of the gas limit of all the transactions in a sublist cannot exceed the sublist’s gas limit.</p>

<blockquote>
  <p>As a result, the cumulative gas than can be used per block is <code class="language-plaintext highlighter-rouge">N * parallelSublistGasLimit + sequentialSublistGasLimit</code>.</p>
</blockquote>

<blockquote>
  <p>In consequence, the transaction gas limit can be as maximum <code class="language-plaintext highlighter-rouge">max{ parallelSublistGasLimit, sequentialSublistGasLimit }</code></p>
</blockquote>

<h2 id="new-block-header-field">New block header field</h2>

<p>A new field <code class="language-plaintext highlighter-rouge">txExecutionSublistsEdges</code> is added to the block header. It determines how transactions are partitioned in a block. This field consists of an array of short unsigned integers that indicates at which position in the transaction list each sublist ends.</p>

<p>For example, in a block with 10 transactions, <code class="language-plaintext highlighter-rouge">txExecutionSublistsEdges = [3, 6]</code> indicates that the first <em>parallel sublist</em> contains transactions 0, 1 and 2; the second <em>parallel sublist</em> contains transactions 3, 4 and 5; and the <em>sequential sublist</em> contains transactions 6 to 9.</p>

<p>A new constant <code class="language-plaintext highlighter-rouge">maxTransactionExecutionThreads</code> is specified. It determines the minimum number of cores required to run the RSK node. Initially, <code class="language-plaintext highlighter-rouge">maxTransactionExecutionThreads = 4</code></p>

<ul>
  <li>Values in <code class="language-plaintext highlighter-rouge">txExecutionSublistsEdges</code> must be greater than 0 and in ascending order.</li>
  <li>An empty <code class="language-plaintext highlighter-rouge">txExecutionSublistsEdges</code> indicates that all transactions go in the <em>sequential sublist</em>.</li>
  <li>The maximum number of parallel sublists that the miner can specify is equal to <code class="language-plaintext highlighter-rouge">maxTransactionExecutionThreads</code>.</li>
  <li>The REMASC transaction must be included as the last transaction of the sequential sublist.</li>
</ul>

<h2 id="new-block-validation-consensus">New block validation consensus</h2>

<p>It must be ensured that blocks that have transactions that are executed in parallel always produce the same output. Therefore, when a block is executed in parallel, nodes must verify the resulting world state is deterministic.</p>

<p>For simplicity, two transactions are defined as <em>connected</em> if:</p>
<ul>
  <li>Both transactions write the same storage key</li>
  <li>One transaction reads a key that the other transaction writes</li>
</ul>

<p>Any pair of transactions that are <em>connected</em> cannot be in different parallel sublists. If so, the block must be rejected.</p>

<blockquote>
  <p>Transactions that are from the same sender account are considered <em>connected</em> because they modify the nonce.</p>
</blockquote>

<blockquote>
  <p>Recursive deletes must be correctly and efficiently handled. If a transaction deletes a contract using <code class="language-plaintext highlighter-rouge">SELFDESTRUCT</code> and another transaction is reading or writing a key of that contract, those two transactions must be considered <em>connected</em>.</p>
</blockquote>

<p>This cases should not be considered as writing a key, since they doesn’t affect the output of the parallel execution:</p>
<ul>
  <li>Adding 0 balance</li>
</ul>

<h3 id="block-validation-algorithm">Block validation algorithm</h3>

<p>A <code class="language-plaintext highlighter-rouge">readMap</code> and a <code class="language-plaintext highlighter-rouge">writeMap</code> is created per <em>parallel sublist</em>. During execution of each sublist,</p>
<ul>
  <li>when a storage key is read, it is marked in the <code class="language-plaintext highlighter-rouge">readMap</code>,</li>
  <li>when a key is written, the key is marked in the <code class="language-plaintext highlighter-rouge">writeMap</code>.</li>
</ul>

<p>When all parallel sublists have finished processing, the <code class="language-plaintext highlighter-rouge">readMap</code>s and <code class="language-plaintext highlighter-rouge">writeMap</code>s are scanned to find connections between transactions of different threads. This requires efficient maps that enable traversing the keys in ascending lexicographic order.</p>
<ul>
  <li>If a key belongs to a <code class="language-plaintext highlighter-rouge">writeMap</code> and a <code class="language-plaintext highlighter-rouge">readMap</code> of another <em>parallel sublist</em>, then the block is considered invalid.</li>
  <li>If a key belongs to a <code class="language-plaintext highlighter-rouge">writeMap</code> and a <code class="language-plaintext highlighter-rouge">writeMap</code> of another <em>parallel sublist</em>, then the block is also considered invalid.</li>
</ul>

<p>The <em>sequential sublist</em> does not need any new validation.</p>

<h1 id="suggested-miner-implementation">Suggested miner implementation</h1>

<p>When a miner executes transactions to create an (unsolved) block, the miner must execute the transactions serially and decide which sublist the transaction belongs to. The block gas limit is replaced by a per-sublist gas limit.</p>

<p>Following the connection types between transactions described above, a transaction is connected to a <em>parallel sublist</em> if it is connected to any transaction in that sublist. The miner maintains a <code class="language-plaintext highlighter-rouge">writeMap</code> and a <code class="language-plaintext highlighter-rouge">readMap</code> that store which sublist/s write or read each storage key. The miner then executes transactions from the pool and keeps track of which storage keys the transaction reads and writes. After executing the transaction, the miner compares the transaction read and written keys with the <code class="language-plaintext highlighter-rouge">readMap</code> and <code class="language-plaintext highlighter-rouge">writeMap</code>. The following scenarios are possible:</p>

<ol>
  <li>The transaction is not connected to any existing sublist:
    <ol>
      <li>The miner assigns the transaction to an empty <em>parallel sublist</em></li>
      <li>If no empty sublist exists, the miner assigns the transaction to the less full <em>parallel sublist</em></li>
      <li>If all <em>parallel sublists</em> are full, the miner assigns the transaction to the <em>sequential sublist</em></li>
    </ol>
  </li>
  <li>The transaction is connected to one <em>parallel sublist</em>:
    <ol>
      <li>The miner assigns the transaction to the <em>parallel sublist</em></li>
      <li>If the <em>parallel sublist</em> is full, the miner assigns the transaction to the <em>sequential sublist</em></li>
    </ol>
  </li>
  <li>The transaction is connected to more than one <em>parallel sublists</em>:
    <ol>
      <li>The miner assigns the transaction to the <em>sequential sublist</em></li>
      <li>Alternatively, the miner might merge the connected sublists and assign the transaction there</li>
    </ol>
  </li>
</ol>

<p>After assigning a transaction to a sublist, the miner updates the <code class="language-plaintext highlighter-rouge">readMap</code> and <code class="language-plaintext highlighter-rouge">writeMap</code> accordingly. When no more transactions can be included in the block, the miner executes the block in parallel to produce the final state.</p>

<p>To prevent DoS attacks, miners only execute a transaction if it fits in the sequential set. In this way, miners are guaranteed to include the transaction in the block regardless of the read and written storage keys.</p>

<h1 id="copyright">Copyright</h1>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer>
    <div class="footer_cont">
        <div class="footer_box">
            <ul class="social-media-list"><li><a href="https://github.com/rsksmart/RSKIPs" target="_blank" rel="noopener"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Visit on Github</span></a></li></ul>
        </div>
    </div>
</footer><script src="../assets/js/dark_mode.js"></script>
    <script src="../../assets/js/dark_mode.js"></script>
  </body>

</html>
