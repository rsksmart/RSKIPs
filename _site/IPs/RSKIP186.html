<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Active Federation creation block height registration | RSK Improvement Proposals</title>
    <meta
      property="og:title"
      content="Active Federation creation block height registration | RSK Improvement Proposals"
    />
    <meta name="description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />

  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="https://ips.rsk.co/IPs/RSKIP186" />
  <meta property="og:url" content="https://ips.rsk.co/IPs/RSKIP186" />
  <meta property="og:site_name" content="RSK Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "https://ips.rsk.co",
      "name": "RSK Improvement Proposals",
      "description": "RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" />
      <!-- Google Fonts -->
      <link href="https://fonts.googleapis.com/css?family=Quicksand:400,700,900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,600,700,800&display=swap" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="RSK Improvement Proposals" /><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script>
</head>
<body><header class="site-header" role="banner">
  <button id="dark-mode-toggle" class="dark-mode-toggle theme-toggle-button">
    <svg class="icon" style="width:24px;height:24px" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.1L13.73,3.13L12.38,4.26L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.33L10.24,7.36L9.19,8.23L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.93L17.93,10.24C18.6,11.15 19,12.28 19,13.5M14.6,20.08L17.37,18.93L17.13,22.28L14.6,20.08M18.93,17.38L20.08,14.61L22.28,17.15L18.93,17.38M20.08,12.42L18.94,9.64L22.28,9.88L20.08,12.42M9.63,18.93L12.4,20.08L9.87,22.27L9.63,18.93Z" />
    </svg>
  </button>


<div class="wrapper"><a class="site-title" rel="author" href="/">RSK Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link underline" href="/all">All</a><a class="page-link underline" href="/scalability">Scalability</a><a class="page-link underline" href="/security">Security</a><a class="page-link underline" href="/usability">Usability</a><a class="page-link underline" href="/fairness">Fairness</a><a class="page-link underline" href="/standardtrack">Standard Track</a></div>





      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Active Federation creation block height registration</h1>
  </header>

  <div class="post-content">
    <h1 id="active-federation-creation-block-height-registration">Active Federation creation block height registration</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">186</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Active Federation creation block height registration</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">19-NOV-20</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">JD</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Sec</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">1</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
  </tbody>
</table>

<h2 id="abstract">Abstract</h2>

<p>When the Federation change voting process finishes, the Bridge emmits a <code class="language-plaintext highlighter-rouge">commit_federation</code> event.
This event can be used to provide a blockchain proof of the Federation address when requested. Nowadays doing this would imply navigating the blockchain to determine when it was emmited, or constantly monitoring said events.</p>

<p>This RSKIP proposes adding on-chain information to easily fetch the block where the Federation was changed for the last time. With the block, a system could provide proof that it belongs to the mainchain.</p>

<p>Additionally, once a Federation migration process finishes, the retiring Federation is removed. This RSKIP proposes to keep the last retiring Federation address in storage, to be used in case there are outstanding funds to migrate after the retiring age.</p>

<h2 id="motivation">Motivation</h2>

<p>When a user gets the Federation address they usually interact with a node/service and have to trust this information. This exposes a risk where a man-in-the-middle kind of attack could lead users to send their funds to an invalid address thus losing them.</p>

<h2 id="specification">Specification</h2>

<h3 id="storage-changes">Storage changes</h3>

<p>The Bridge will store three new values:</p>
<ul>
  <li>activeFederationCreationBlockHeight. (long)
    <ul>
      <li>Defaults to the existing Federation activation height</li>
    </ul>
  </li>
  <li>nextFederationCreationBlockHeight. (long)
    <ul>
      <li>Defaults to null.</li>
    </ul>
  </li>
  <li>lastRetiredFederationAddress. (btcAddress)
    <ul>
      <li>Defaults to null.</li>
    </ul>
  </li>
</ul>

<h3 id="commit-federation-process-changes">Commit Federation process changes</h3>

<p>When a new Federation is committed and the <code class="language-plaintext highlighter-rouge">commit_federation</code> event is triggered, the Bridge will store the block height in <code class="language-plaintext highlighter-rouge">nextFederationCreationBlockHeight</code>.</p>

<p>When the Federation is committed, after setting the retiring Federation as the previous one, Bridge will set <code class="language-plaintext highlighter-rouge">lastRetiredFederationAddress</code> using the retiring Federation as its value.</p>

<h3 id="updatecollections-method-changes">updateCollections method changes</h3>

<p>The updateCollections method is responsible for the supporting operations of the Bridge, as such, this method now will have to check if a new Federation became Active.</p>

<p>When a new Federation activates, the Bridge will replace <code class="language-plaintext highlighter-rouge">activeFederationCreationBlockHeight</code> with the value in <code class="language-plaintext highlighter-rouge">nextFederationCreationBlockHeight</code> and clear the value of <code class="language-plaintext highlighter-rouge">nextFederationCreationBlockHeight</code>.</p>

<h3 id="registerbtctransaction-method-changes">registerBtcTransaction method changes</h3>

<p>During the peg-in process, the Bridge evaluates which kind of BTC transaction it is requested to register. To detect if it’s a migration, it checks if the sender is the retiring Federation, and if the recipient is the active Federation. Add to this check that the sender could be the retiring Federation, or the last Retired Federation.</p>

<h3 id="getactivefederationcreationblockheight-method">getActiveFederationCreationBlockHeight method</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getActiveFederationCreationBlockHeight() returns uint256
</code></pre></div></div>

<p>This method will return the Active Federation block height. To do this, it should:</p>
<ul>
  <li>check if there is a value for <code class="language-plaintext highlighter-rouge">nextFederationCreationBlockHeight</code>.
    <ul>
      <li>If so, it should verify if the current block is higher than or equals to <code class="language-plaintext highlighter-rouge">nextFederationCreationBlockHeight</code> + <code class="language-plaintext highlighter-rouge">federationActivationAge</code> (Mainnet: 18500, Testnet: 60, Regtest: 10).
        <ul>
          <li>If so, it should return <code class="language-plaintext highlighter-rouge">nextFederationCreationBlockHeight</code>.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Otherwise, it should return the value stored in <code class="language-plaintext highlighter-rouge">activeFederationCreationBlockHeight</code>.</li>
</ul>

<h2 id="rationale">Rationale</h2>

<h3 id="scope">Scope</h3>

<p>This RSKIP only contemplates the consensus changes, this means that the Bridge will expose a method to get the block, but not a way to generate the merkle proof of said block’s inclusion in the blockchain. Once the consensus changes are in place anyone (e.g. the rskj node) could provide a method to fetch the Federation address with merkleproof.</p>

<h3 id="federation-activation">Federation activation</h3>

<p>When a new Federation is committed, this doesn’t mean the Federation changes immediately, for this to happen a number of blocks has to be mined (18500 in Mainnet), this is the reason why the RSKIP proposes to store two values. It’s important that the block height returned corresponds to the active Federation (return with the Bridge method <code class="language-plaintext highlighter-rouge">getFederationAddress()</code>).</p>

<h3 id="default-federation-activation-block-value">Default Federation activation block value</h3>

<p>There is a risk that in between the node deploy and the consensus activation an unexpected Federation change occurs. If this would happen, the source code could point to an older active Federation creation block.
The only way to solve this would be to ensure that the Federation is not changed once the code is deployed and before the network upgrade is active.</p>

<h3 id="copyright">Copyright</h3>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer>
    <div class="footer_cont">
        <div class="footer_box">
            <ul class="social-media-list"><li><a href="https://github.com/rsksmart/RSKIPs" target="_blank" rel="noopener"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Visit on Github</span></a></li></ul>
        </div>
    </div>
</footer><script src="../assets/js/dark_mode.js"></script>
    <script src="../../assets/js/dark_mode.js"></script>
  </body>

</html>
