<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Stack-overflow removal | RSK Improvement Proposals</title>
    <meta
      property="og:title"
      content="Stack-overflow removal | RSK Improvement Proposals"
    />
    <meta name="description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />

  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="https://ips.rsk.co/IPs/RSKIP209" />
  <meta property="og:url" content="https://ips.rsk.co/IPs/RSKIP209" />
  <meta property="og:site_name" content="RSK Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "https://ips.rsk.co",
      "name": "RSK Improvement Proposals",
      "description": "RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" />
      <!-- Google Fonts -->
      <link href="https://fonts.googleapis.com/css?family=Quicksand:400,700,900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,600,700,800&display=swap" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="RSK Improvement Proposals" /><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script>
</head>
<body><header class="site-header" role="banner">
  <button id="dark-mode-toggle" class="dark-mode-toggle theme-toggle-button">
    <svg class="icon" style="width:24px;height:24px" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.1L13.73,3.13L12.38,4.26L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.33L10.24,7.36L9.19,8.23L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.93L17.93,10.24C18.6,11.15 19,12.28 19,13.5M14.6,20.08L17.37,18.93L17.13,22.28L14.6,20.08M18.93,17.38L20.08,14.61L22.28,17.15L18.93,17.38M20.08,12.42L18.94,9.64L22.28,9.88L20.08,12.42M9.63,18.93L12.4,20.08L9.87,22.27L9.63,18.93Z" />
    </svg>
  </button>


<div class="wrapper"><a class="site-title" rel="author" href="/">RSK Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link underline" href="/all">All</a><a class="page-link underline" href="/scalability">Scalability</a><a class="page-link underline" href="/security">Security</a><a class="page-link underline" href="/usability">Usability</a><a class="page-link underline" href="/fairness">Fairness</a><a class="page-link underline" href="/standardtrack">Standard Track</a></div>





      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Stack-overflow removal</h1>
  </header>

  <div class="post-content">
    <h1 id="stack-overflow-removal">Stack-overflow removal</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">209</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Stack-overflow removal</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">JAN-2021</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">SDL</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Sec</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">2</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>discussions-to</strong></td>
      <td style="text-align: left">https://research.rsk.dev/t/rskip-209-stack-overflow-removal/147</td>
    </tr>
  </tbody>
</table>

<h1 id="abstract"><strong>Abstract</strong></h1>

<p>One of the contributions to the security of the EVM virtual machine was the removal of the stack-overflow check in <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-150.md">EIP150</a>, making calls fully dependent only on the available gas. However, the way this was accomplished brought several problems, as described in depth <a href="https://medium.com/iovlabs-innovation-stories/the-dark-side-of-ethereum-1-64th-call-gas-reduction-ba661778568c">this</a> article. This RSKIP proposes a better method to achieve the same result, based on reimbursing the gas locked in <code class="language-plaintext highlighter-rouge">CALL</code> at the end of the transaction, instead of when <code class="language-plaintext highlighter-rouge">CALL</code> ends.</p>

<h2 id="motivation">Motivation</h2>

<p>The EIP150 allows the whole state of a call to be specified by only 3 parameters, the value transferred, the calldata and the gas limit. Before, the stack-depth was also part of the environment of a call, that could influence the call outcome. EIP150 introduces a lock of 1/64 of the gas in each <code class="language-plaintext highlighter-rouge">CALL</code> and this amount is reimbursed when the <code class="language-plaintext highlighter-rouge">CALL</code> finishes. However, this prevents the easy creation of a gas exactimator. A gas exactimator is a function that can compute the correct gas limit for a transaction by executing it only once.</p>

<p>For this reason the EIP150 did not achieve consensus by the RSK community. This RSKIP brings the same functionality, but in a way that enables a simple gas exactimator.</p>

<h2 id="specification">Specification</h2>

<p>Every  <code class="language-plaintext highlighter-rouge">CALL</code> locks 1/64 factor of the current available gas, like EIP150, but the locked gas is not immediately reimbursed when the CALL finishes, but at the end of transaction processing. Internally, the environment stores, for each stack depth, the amount of gas locked.  Assuming <strong>lockedGasByDepth</strong> is an array of integer values that are all initialized with zero, the pseudo-code is the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>consumeGas(standard_call_costs); // 700 + value-transfer cost, etc.
callGas = min(top-of-stack item,availableGas)
lockGas = availableGas/64;
maxGasToPassCallee = availGas-lockGas
if (callGas&gt;maxGasToPassCallee) {
 	forbiddenGas =callGas-maxGasToPassCallee
 	if (forbiddenGas&gt;lockedGasByDepth[currentCallDepth]) {
		expectedLock = forbiddenGas-lockedGasByDepth[currentCallDepth];
  		consumeGas(expectedLock);
  		callReimbursement +=expectedLock;
  		lockedGasByDepth[currentCallDepth] = forbiddenGas; // can only increase
	} 
}
</code></pre></div></div>

<p>The command consumeGas() reduces the available gas by the given amount and can rise an OOG exception.</p>

<p>After the transaction has been processed, the gas callReimbursement is reimbursed to the origin, by the same mechanism other reimbursements occur, such as reimbursements storage freed by <code class="language-plaintext highlighter-rouge">SEFLDESTROY</code>.</p>

<h2 id="rationale">Rationale</h2>

<p>The objective of releasing the gas at the end of the transaction is to enable a gas exactimator to be used. Three methods are compared to decide a good balance between cost for simple and complex transactions, while still preventing DoS attacks. We evaluated 3 parameters sets, involving both constant and proportional gas cost per call:</p>

<ol>
  <li>Locking 1/64 of the available gas (as EIP150)</li>
  <li>Locking a 10000 gas</li>
  <li>Locking 3000 gas and 1/80 of the available gas</li>
</ol>

<p>First we present an optimized algorithm for constant amount subtraction.</p>

<h3 id="constant-amount-subtraction">Constant Amount Subtraction</h3>

<p>The execution environment stores, along the call stack, two non-negative integer values: <strong>maxDepthReached</strong> and <strong>callReimbursement</strong>.  Both values start at zero when transaction execution begins. The following pseudo-code is executed before a <code class="language-plaintext highlighter-rouge">CALL</code> is performed. The variable <strong>currentCallDepth</strong> refers to the current call stack depth (zero means no call has been performed).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (currentCallDepth==maxDepthReached) {
  consumeGas(10000);
  callReimbursement +=10000;
  maxDepthReached += 1;
} 
</code></pre></div></div>

<h3 id="comparison">Comparison</h3>

<p>We compare the 3 algorithms in 4 scenarios A,B,C and D:</p>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><strong>A</strong>. Standard DeFi transaction consuming 200k gas and reaching a call depth of 20</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><strong>B</strong>. Complex  DeFi transaction consuming 500k gas and reaching a call depth of 50</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><strong>C</strong>. Attack on the client to reach the maximum possible stack depth in order to overflow the program stack, consuming all gas of block with a 10M block gas limit.</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><strong>D</strong>. Smart-contract that tries to reach the a stack level where it can perform the maximum number of SLOADs in order to force a state cache data structure to query linearly over caches created at each depth, consuming all gas of block with a 10M block gas limit.</li>
</ul>

<p>We present the results in a table. To compute the results, we add a constant gas consumption of 700 gas per CALL, which accounts for the cost of the <code class="language-plaintext highlighter-rouge">CALL</code> opcode itself.</p>

<p>For scenario A we show the amount of gas available at depth 20. For scenario B we show the amount of gas available at depth 50. For scenario C we show the depth reached. For scenario D we show the maximum amount of SLOADs that can be achieved and the depth in brackets.</p>

<table>
  <thead>
    <tr>
      <th>Method / Scneario</th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
      <th>D</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1. gas/64</td>
      <td>133867</td>
      <td>203111</td>
      <td>343</td>
      <td>1159083 (depth 63)</td>
    </tr>
    <tr>
      <td>2. 10000</td>
      <td>OOG at depth 18</td>
      <td>OOG at depth 46</td>
      <td>934</td>
      <td>11682238 (depth 467)</td>
    </tr>
    <tr>
      <td>3. gas/80+3000</td>
      <td>89686</td>
      <td>128411</td>
      <td>282</td>
      <td>1392302 (depth 74)</td>
    </tr>
  </tbody>
</table>

<p>The desired solution should not require a stack deeper than 400. The solution to charge a constant amount (10K) has the benefit that requires a simpler implementation. However, it is expensive for scenarios A and B and does not limit the stack depth enough. The chosen solution (1) surpasses 400 if the transaction gas limit reaches 25M gas, and therefore the block gas limit should be hard limited to 24M. In general, solution 1 provides the best results, and has the added benefit that provides higher compatibility with EIP150.</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>This change is a hard-fork and therefore all full nodes must be updated. SPV light-clients and Block explorers do not need to be updated. While contracts are discouraged to embed gas constants in the code, those contracts may break because of the added CALL cost.</p>

<h2 id="test-cases">Test Cases</h2>

<p>TBD</p>

<h2 id="security-considerations">Security Considerations</h2>

<p>This RSKIP protects the RSK network from attacks to contracts that perform user-specified calls where gas is paid by a sponsor who is reimbursed. In those cases, a relayer-induced stack overflow can cause the user-specified call to fail and the reimbursement is performed. By limiting the environment that affects a call to controlled set of variables that contracts can check, this risk is mitigated. Other solutions to the same problem are <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP203.md">RSKIP203</a> (not generic enough) and <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP208.md">RSKIP208</a>, which helps these contracts only if they are programmed to use the precompiled enabled by the RSKIP.</p>

<h1 id="copyright"><strong>Copyright</strong></h1>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.,</p>


  </div>

</article>

      </div>
    </main><footer>
    <div class="footer_cont">
        <div class="footer_box">
            <ul class="social-media-list"><li><a href="https://github.com/rsksmart/RSKIPs" target="_blank" rel="noopener"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Visit on Github</span></a></li></ul>
        </div>
    </div>
</footer><script src="../assets/js/dark_mode.js"></script>
    <script src="../../assets/js/dark_mode.js"></script>
  </body>

</html>
