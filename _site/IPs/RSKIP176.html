<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Programmable Peg-in Addresses for faster peg-ins | RSK Improvement Proposals</title>
    <meta
      property="og:title"
      content="Programmable Peg-in Addresses for faster peg-ins | RSK Improvement Proposals"
    />
    <meta name="description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />

  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="https://ips.rsk.co/IPs/RSKIP176" />
  <meta property="og:url" content="https://ips.rsk.co/IPs/RSKIP176" />
  <meta property="og:site_name" content="RSK Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "https://ips.rsk.co",
      "name": "RSK Improvement Proposals",
      "description": "RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" />
      <!-- Google Fonts -->
      <link href="https://fonts.googleapis.com/css?family=Quicksand:400,700,900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,600,700,800&display=swap" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="RSK Improvement Proposals" /><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script>
</head>
<body><header class="site-header" role="banner">
  <button id="dark-mode-toggle" class="dark-mode-toggle theme-toggle-button">
    <svg class="icon" style="width:24px;height:24px" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.1L13.73,3.13L12.38,4.26L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.33L10.24,7.36L9.19,8.23L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.93L17.93,10.24C18.6,11.15 19,12.28 19,13.5M14.6,20.08L17.37,18.93L17.13,22.28L14.6,20.08M18.93,17.38L20.08,14.61L22.28,17.15L18.93,17.38M20.08,12.42L18.94,9.64L22.28,9.88L20.08,12.42M9.63,18.93L12.4,20.08L9.87,22.27L9.63,18.93Z" />
    </svg>
  </button>


<div class="wrapper"><a class="site-title" rel="author" href="/">RSK Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link underline" href="/all">All</a><a class="page-link underline" href="/scalability">Scalability</a><a class="page-link underline" href="/security">Security</a><a class="page-link underline" href="/usability">Usability</a><a class="page-link underline" href="/fairness">Fairness</a><a class="page-link underline" href="/standardtrack">Standard Track</a></div>





      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Programmable Peg-in Addresses for faster peg-ins</h1>
  </header>

  <div class="post-content">
    <h1 id="programmable-peg-in-addresses-for-faster-peg-ins">Programmable Peg-in Addresses for faster peg-ins</h1>
<p>|RSKIP          | 176 |
| :———— |:————-|
|<strong>Title</strong>      |Programmable Peg-in Addresses for faster peg-ins |
|<strong>Created</strong>    |15-SEP-20 |
|<strong>Author</strong>     |SDL, GM |
|<strong>Purpose</strong>    |USA |
|<strong>Layer</strong>      |Core |
|<strong>Complexity</strong> |2 |
|<strong>Status</strong>     |Adopted |</p>

<h2 id="abstract">Abstract</h2>

<p>This RSKIP proposes an RSK protocol change called <strong>Programmable Peg-in Addresses (PPA)</strong> (formerly known as “fast peg-in”) that enables to send bitcoins to RSK over <em>Powpeg-derived</em> addresses, where each derived address has a peg-in execution code cryptographically linked into it. To receive the RBTC of a PPA peg-in, a smart contract must send to the Bridge the BTC transaction and Merkle proof, together with proof that the derived address is actually controlled by the Powpeg. If this proof is verified, the Bridge contract redeems the funds by executing the associated code. The code to be executed is succinctly specified as a contract method to be called, and the arguments to pass to the call. At the RSK consensus layer this protocol change only affects the Bridge contract. However, to make use of all features enabled by PPA, additional user-defined contracts that handle code execution must be deployed, and users and wallets must be aware of the new peg-in workflow.  One of the goals with this change is the deployment of the Flyover protocol, which is a specific peg-in execution engine that allows users to peg-in BTC to RSK in a fast way, where a third party advances the payment in RBTC to the user, while taking the bitcoin blockchain double-spend risk.</p>

<h2 id="motivation">Motivation</h2>

<p>The RSK Bridge is presently slow, from the perspective of the end user. This is an intentional a security feature included by design, and not a bug. The bridge was designed so that users willing to accelerate the peg-in experience would either use centralized exchanges, wallets connected to token swaps APIs, or decentralized atomic swap protocols, while large liquidity providers would use the slow native bridge. In practice, users have been reluctant to use peg-in acceleration services for different reasons: high cost, lack of RBTC exchange pairs, lack of swap API integrations into wallets, lack of privacy, or a bad UX that comes from the need of pre-register an identity in many of these services. There is a clear need for fast, or even instantaneous, transfer of BTC on the Bitcoin network to RBTC on the RSK network.</p>

<p>A first solution is to accept peg-ins from Lightning network, using a technique called submarine swap, which doesn’t require consensus changes. However, not all wallets have LN support. Another solution, described in this proposal, is to enable peg-ins to RSK with a only few Bitcoin confirmations, using third parties (called liquidity providers or LPs for short) to provide an advance of RBTCs in RSK to the users, while the LPs wait 100 bitcoin confirmations to be reimbursed. The number 100 is the number of blocks required by the RSK Bridge to release coins that were pegged-in. LPs can be assured they will be promptly reimbursed embedding execution scripts programmed right into the Powpeg addresses used for peg-in. Therefore, new peg-in addresses must be issued for each peg-in. The simplest way to describe an embedded script is to specify a destination contract (called Liquidity Bridge Contract or LBC) to handle the execution, and some arguments that the LBC knows how to parse. Since LPs are taking calculated risks that transactions on the Bitcoin network are not double-spent prior to attaining 100 block confirmations, they may charge a fee for providing the RBTC-advancement service. More complex LBCs may enable the creation of a free market between users who wants to peg-in faster and parties who provide the liquidity to advance the payment in a fully trust-minimized, open and censorship-resistant way. It is even possible to create an LBC that assigns addresses to smart-contracts on RSK, so users can send BTC directly to specific contracts on RSK just by specifying their unique Bitcoin address.</p>

<h2 id="specification">Specification</h2>

<p>The <strong>Powpeg Redeem Script</strong> (PRS, also called federation redeem script), is the the script referenced by script hash inside the Powpeg P2SH peg-in address. It contains the Powpeg multisig and emergency multisig spending paths. A <strong>derived Powpeg address</strong> is built by combining a value called <strong>User Peg-in Identification</strong> (UPI) with the PRS. The UPI consist of exactly 32 bytes provided by the user that performs the peg-in. The UPI in turn is the hash of some <strong>Internal Derivation Arguments</strong> (IDAs). The UPI is built as the keccack256 hash digest of the IDAs, serialized in a custom format. While the IDAs can be freely chosen by the user creating the peg-in transaction, each IDA has a special function recognized by the Bridge contract.  One of the IDAs is itself a hash of <strong>External Derivation Arguments</strong> (EDAs). The EDAs are referenced by the <strong>derivationArgumentsHash</strong> function argument described in the next section. The EDAs are referenced by a hash digest instead of explicitly because they are ignored by the Bridge. In the case of the Flyover protocol, both IDAs and EDAs represent an agreement signed between the Liquidity Provider and the user willing to perform the peg-in. The agreement contains the Terms of Service (ToS). Other protocols may use the EDAs for other purposes.</p>

<h4 id="bridge">Bridge</h4>

<p>A new method called <strong>registerFastBridgeBtcTransaction</strong>() is added to the Bridge contract will the following ABI signature:</p>

<pre><code class="language-Solidity">    function registerFastBridgeBtcTransaction(
		bytes btcTxSerialized, 
		uint256 height,
		bytes pmtSerialized, 
		bytes32 derivationArgumentsHash, 
		bytes userRefundBtcAddress, 
		address liquidityBridgeContractAddress, 
		bytes liquidityProviderBtcAddress, 
		bool shouldTransferToContract) returns int executionStatus
</code></pre>

<p><strong>Parameters</strong>:</p>

<ul>
  <li><em>bytes</em> <strong>btcTxSerialized</strong>: Serialized Bitcoin transaction (tx) following the standard Bitcoin serialization format.</li>
  <li><em>uint256</em> <strong>height</strong>: BTC block number where the transaction is present. The value passed is truncated to a 32-bit unsigned integer. Caller must verify that the value passed is in the correct range.</li>
  <li><em>bytes</em> <strong>pmtSerialized</strong>: Serialized partial Merkle tree (following bitcoinj structure) that proves that the transaction belongs to the indicated block.</li>
  <li><em>bytes32</em> <strong>derivationArgumentsHash</strong>: A keccak265 hash of the external derivation arguments (EDAs).</li>
  <li><em>bytes</em> <strong>userRefundBtcAddress</strong>: Binary encoding representing the user BTC refund address.</li>
  <li><em>address</em> <strong>liquidityBridgeContractAddress</strong>: The RSK Liquidity Bridge Contract address.</li>
  <li><em>bytes</em> <strong>liquidityProviderBtcAddress</strong>: Binary encoding representing  the Liquidity Provider BTC refund address.</li>
  <li><em>bool</em> <strong>shouldTransferToContract</strong>: Status provided by the caller contract to know if should transfer value to the contract or not.</li>
</ul>

<p>To compute the UPI, the IDAs are serialized as a concatenation of derivationArgumentsHash (32 bytes), userRefundBtcAddress (21 bytes), liquidityProviderBtcAddress (21 bytes), liquidityBridgeContractAddress (20 bytes). Each argument occupies a fixed number of bytes shown in brackets. Formally, this is:</p>

<p><code class="language-plaintext highlighter-rouge">UPI = Keccak256(derivationArgumentsHash, userRefundBtcAddress, liquidityProviderBtcAddress , liquidityBridgeContractAddress)</code></p>

<p>The total number of bytes hashed is 94. Note that the concatenation order is different from the argument passing order.</p>

<p><strong>Checks and Operations Performed by registerFastBridgeBtcTransaction</strong>:</p>

<ul>
  <li>
    <p>The caller must be a contract (not an EOA). This check was found to be unecessary and may be removed by a future RSKIP.</p>
  </li>
  <li>
    <p>Compute <strong>btcTxHash</strong> as the Bitcoin hash of btcTxSerialized.</p>
  </li>
  <li>
    <p>Bridge receives a call from a contract (an alleged Liquidity Bridge Contract) and validates that the sender of that call is effectively the LBC address, that is received as parameter liquidityBridgeContractAddress.</p>
  </li>
  <li>
    <p>Performs the same validations done in <strong>registerBtcTransaction</strong> to determine if the BTC transaction is legitimate (e.g.: txAlreadyProcessed, confirmations, Partial Merkle Tree inclusion, etc).</p>
  </li>
  <li>
    <p>Computes the derived Powpeg address (<strong>derivedPowpegAddress</strong>) built using the UPI constructed from the passed arguments.</p>
  </li>
  <li>
    <p>Computes the amount of funds sent by the transaction tx to the derivedPowpegAddress (<strong>totalAmount</strong>). If the amount is zero, aborts.</p>
  </li>
  <li>
    <p>Checks if the derivation hash was used already. If so, it refunds the bitcoin sender specified by the userRefundBtcAddress argument.</p>
  </li>
  <li>
    <p>Verifies that the caller matches the liquidityBridgeContractAddress. This address may not be a contract, but a External Owned Account (EOA).</p>
  </li>
  <li>
    <p>Depending on the shouldTransferToContract value received as parameter:</p>
  </li>
  <li>If <strong>true</strong>, Bridge will check if Locking Cap value is surpassed:
    <ul>
      <li>If not surpassed:
        <ul>
          <li>transfers the totalAmount to the Liquidity Bridge Contract</li>
          <li>saves information related to the derivedPowpegAddress in the contract storage. The cell whose address is obtained by the <strong>getStorageKeyForfastBridgeFederationInformation</strong>(redeemScriptHash) method. The <strong>redeemScriptHash</strong> is the Bitcoin hash of the Powpeg P2SH Redeem Script associated with the derived Powpeg address (called <strong>fastBridgeRedeemScriptHash</strong>). The data to be stored is the RLP encoding of UPI and the Powpeg P2SH Redeem Script hash for the redeem script with the UPI removed (called <strong>powpegRedeemScriptHash</strong>). This last redeem script matches the standard generic Powpeg redeem script for any non-fast peg-in.</li>
          <li>Marks the tuple (btcTxHash, UPI) in Bridge storage to that it cannot be reused. To do so the Bridge computes an unique storage address using the function <strong>getStorageKeyForDerivationArgumentsHash</strong>(btcTxHash, UPI), and stores the byte value 1 in the storage cell at that address. This enables the preventing the same transaction to be processed twice for the same UPI. This storage cell is never erased.</li>
          <li>marks tx as processed.</li>
          <li>stores all the UTXOs from tx that pay to the derived Powpeg address. The UTXOs are stored exactly as it is already done for regular peg-in UTXOs.</li>
        </ul>
      </li>
      <li>If surpassed, the Bridge refunds the Liquidity Provider at liquidityProviderBtcAddress.</li>
    </ul>
  </li>
  <li>
    <p>If <strong>false</strong>:</p>

    <ul>
      <li>Refunds bitcoin sender at address userRefundBtcAddress.</li>
    </ul>
  </li>
  <li>
    <p>Returns an integer value indicating the execution status:</p>

    <p><code class="language-plaintext highlighter-rouge">&lt; 0 : Error </code></p>

    <p><code class="language-plaintext highlighter-rouge">0 : Call method before fork activation </code></p>

    <p><code class="language-plaintext highlighter-rouge">&gt; 0 : Value transfered to user</code></p>
  </li>
</ul>

<h4 id="error-codes">Error codes</h4>

<p><code class="language-plaintext highlighter-rouge">FAST_BRIDGE_REFUNDED_USER_ERROR_CODE = -100</code></p>

<p><code class="language-plaintext highlighter-rouge">FAST_BRIDGE_REFUNDED_LP_ERROR_CODE = -200</code></p>

<p><code class="language-plaintext highlighter-rouge">FAST_BRIDGE_UNPROCESSABLE_TX_NOT_CONTRACT_ERROR_CODE = -300</code></p>

<p><code class="language-plaintext highlighter-rouge">FAST_BRIDGE_UNPROCESSABLE_TX_INVALID_SENDER_ERROR_CODE = -301</code></p>

<p><code class="language-plaintext highlighter-rouge">FAST_BRIDGE_UNPROCESSABLE_TX_ALREADY_PROCESSED_ERROR_CODE = -302</code></p>

<p><code class="language-plaintext highlighter-rouge">FAST_BRIDGE_UNPROCESSABLE_TX_VALIDATIONS_ERROR = -303</code></p>

<p><code class="language-plaintext highlighter-rouge">FAST_BRIDGE_UNPROCESSABLE_TX_VALUE_ZERO_ERROR = -304</code></p>

<p><code class="language-plaintext highlighter-rouge">FAST_BRIDGE_GENERIC_ERROR = -900</code></p>

<h4 id="new-bridge-storage-address-mappings">New Bridge Storage Address Mappings</h4>

<p>The utility function <strong>getStorageKeyForDerivationArgumentsHash</strong>(btcTxHash, UPI) computes a unique storage cell address as the keccack256 hash of the following string:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"fastBridgeHashUsedInBtcTx-" + btcTxHash.toHexString() + UPI.toHexString()
</code></pre></div></div>

<p>Where “+” represents string concatenation and the toHexString() method returns the ASCII hexadecimal representation of the data without the “0x” prefix, using lowercase letters, and without trimming leading zeros . The btcTxHash hexadecimal string is always 64 bytes in length. The UPI hexadecimal string is always 64 bytes in length. No separator is used between these two hexadecimal strings.</p>

<p>The utility function <strong>getStorageKeyForfastBridgeFederationInformation</strong>(redeemScriptHash) computes a unique storage cell address as the keccack256 hash of the following string:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"fastBridgeFederationInformation-" + redeemScriptHash.toHexString()
</code></pre></div></div>

<p>The redeemScriptHash hexadecimal string is always 64 bytes in length.</p>

<h4 id="limitations">Limitations</h4>

<ul>
  <li>Bitcoin Transactions with a depth higher than 4320 will not be processed. Normally this depth will be enough to register a transaction that is a month old. An attempt to register a peg-in with higher depth will result in an error and the pegged-in funds will be lost.</li>
</ul>

<h4 id="flow-chart">Flow chart</h4>
<p><img src="/IPs/RSKIP176/registerFastBridgeBtcTransactionFlow.png" alt="registerFastBridgeBtcTransaction() flow" /></p>

<h3 id="powpeg-address-derivation">Powpeg Address Derivation</h3>

<p>The Powpeg address derivation starts with the creation of a custom redeem script that pushes the UPI (a 32 bytes hash). That data pushed is immediately dropped from the stack using the OP_DROP opcode, so the pushed data does not alter the processing of the redeem script.</p>

<p>The redeem script for Powpeg-derived addresses is a modification of the standard Powpeg redeem script. In this section we show how to build such scripts, but we omit the emergency multisig script path for clarity.  The whole script must be considered when computing the address. A following RSKIP will specify the addition to the Bridge contract of a method to retrieve a custom redeem script based on a given UPI, as currently this process must be done by an ad-hoc library. The new custom redeem script has the following format:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scriptPubKey: OP_HASH160 &lt;redeemScriptHash&gt; OP_EQUAL
scriptSig: OP_0 &lt;signatures&gt; &lt;redeemScript&gt;
redeemScript: &lt;derivationArgumentsHash&gt; OP_DROP OP_M &lt;publicKeys&gt; OP_N OP_CHECKMULTISIG
</code></pre></div></div>

<p>This custom redeem script is executed in the same way to the standard script, allowing the same pegnatories to sign transactions consuming bitcoins from these ad-hoc addresses.</p>

<h3 id="rationale">Rationale</h3>
<p>This RSKIP is an improvement over the <a href="https://github.com/rsksmart/RSKIPs/blob/fast-bridge/IPs/RSKIP175.md" title="RSKIP 175">RSKIP 175</a>, but this alternative was chosen as the reference node does not support that the Bridge calls an external contracts, and adding this feature was risky. Therefore, the flow was inverted and the LBC first takes control, then calls the Bridge, and then regain control to finish the peg-in operation.</p>

<p><strong>Derivation Arguments</strong></p>

<p>The internal and external derivation arguments are values used as part of the agreement between the Liquidity Provider and the user. Some of these arguments are the RSK address where funds will be received, the BTC refund address, the Liquidity Bridge Contract address, the value to transfer, the amount of BTC blocks that the Liquidity Provider should wait before advancing the funds, the Liquidity Provider BTC refund address, the derived Federation address,.</p>

<h3 id="copyright">Copyright</h3>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer>
    <div class="footer_cont">
        <div class="footer_box">
            <ul class="social-media-list"><li><a href="https://github.com/rsksmart/RSKIPs" target="_blank" rel="noopener"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Visit on Github</span></a></li></ul>
        </div>
    </div>
</footer><script src="../assets/js/dark_mode.js"></script>
    <script src="../../assets/js/dark_mode.js"></script>
  </body>

</html>
