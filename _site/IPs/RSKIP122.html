<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>New method GetBtcTransactionConfirmations for Bridge contract | RSK Improvement Proposals</title>
    <meta
      property="og:title"
      content="New method GetBtcTransactionConfirmations for Bridge contract | RSK Improvement Proposals"
    />
    <meta name="description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />

  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="https://ips.rsk.co/IPs/RSKIP122" />
  <meta property="og:url" content="https://ips.rsk.co/IPs/RSKIP122" />
  <meta property="og:site_name" content="RSK Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "https://ips.rsk.co",
      "name": "RSK Improvement Proposals",
      "description": "RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" />
      <!-- Google Fonts -->
      <link href="https://fonts.googleapis.com/css?family=Quicksand:400,700,900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,600,700,800&display=swap" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="RSK Improvement Proposals" /><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script>
</head>
<body><header class="site-header" role="banner">
  <button id="dark-mode-toggle" class="dark-mode-toggle theme-toggle-button">
    <svg class="icon" style="width:24px;height:24px" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.1L13.73,3.13L12.38,4.26L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.33L10.24,7.36L9.19,8.23L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.93L17.93,10.24C18.6,11.15 19,12.28 19,13.5M14.6,20.08L17.37,18.93L17.13,22.28L14.6,20.08M18.93,17.38L20.08,14.61L22.28,17.15L18.93,17.38M20.08,12.42L18.94,9.64L22.28,9.88L20.08,12.42M9.63,18.93L12.4,20.08L9.87,22.27L9.63,18.93Z" />
    </svg>
  </button>


<div class="wrapper"><a class="site-title" rel="author" href="/">RSK Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link underline" href="/all">All</a><a class="page-link underline" href="/scalability">Scalability</a><a class="page-link underline" href="/security">Security</a><a class="page-link underline" href="/usability">Usability</a><a class="page-link underline" href="/fairness">Fairness</a><a class="page-link underline" href="/standardtrack">Standard Track</a></div>





      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">New method GetBtcTransactionConfirmations for Bridge contract</h1>
  </header>

  <div class="post-content">
    <h1 id="new-method-getbtctransactionconfirmations-for-bridge-contract">New method GetBtcTransactionConfirmations for Bridge contract</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">122</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">New method GetBtcTransactionConfirmations for Bridge contract</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">03-May-19</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">AM</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Usa</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">2</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
  </tbody>
</table>

<h2 id="abstract">Abstract</h2>

<p>A new method for the Bridge contract is introduced. This method provides a service to verify whether a given transaction belongs to a given block within the Bridge contract’s view of the Bitcoin blockchain.</p>

<h2 id="motivation">Motivation</h2>

<p>With the arising need of BTOs (Bitcoin Token Offerings) on top of the RSK network, the ability for RSK smart contracts to test whether a certain Bitcoin transaction has been mined (and how many blocks ago) becomes mandatory. Note that the possibility of ad-hoc implementations doesn’t exist, since to this day there is no method (or group of methods) that enable a smart contract to inspect the Bridge contract’s Bitcoin block headers. When designing the implementation, the decision favored a simple unique method tailored at both verifying the inclusion of a given transaction in a given block (via an SPV proof) as well as the inclusion of the latter in the Bridge’s Bitcoin blockchain, thus proving or disproving the mined status of any given Bitcoin transaction. As a corollary, the method also informs the number of confirmations for the block, enhancing the calling contract’s decision making ability with  a more fine-grained control.</p>

<h2 id="specification">Specification</h2>

<p>A new method for the Bridge precompiled contract (accessible at the <code class="language-plaintext highlighter-rouge">0x0000000000000000000000000000000001000006</code> address) is available. Its signature is as follows:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">getBtcTransactionConfirmations(bytes32, bytes32, uint256, bytes32[]) returns (int256)</code></li>
</ul>

<h3 id="parameters">Parameters</h3>

<p>The <code class="language-plaintext highlighter-rouge">getBtcTransactionConfirmations</code> method takes four parameters. In order, these are:</p>

<ol>
  <li>The Bitcoin transaction hash (<code class="language-plaintext highlighter-rouge">bytes32</code>): this is the hash of the transaction that is to be checked for inclusion in the Bitcoin blockchain.</li>
  <li>The Bitcoin block hash (<code class="language-plaintext highlighter-rouge">bytes32</code>): this is the hash of the block that is to be checked for both including the given transaction and inclusion in the Bitcoin blockchain (thus then proving the transaction’s own inclusion in the blockchain).</li>
  <li>The merkle branch path (<code class="language-plaintext highlighter-rouge">uint256</code>): this is the “path” portion of the merkle branch (see the corresponding section for details).</li>
  <li>The merkle branch hashes (<code class="language-plaintext highlighter-rouge">bytes32[]</code>): this is the “hashes” portion of the merkle branch (see the corresponding section for details).</li>
</ol>

<h3 id="return-values">Return values</h3>

<p>The <code class="language-plaintext highlighter-rouge">getBtcTransactionConfirmations</code> returns a single integer (<code class="language-plaintext highlighter-rouge">int256</code>) as a result of its execution. This can either represent <em>success</em> (i.e., the transaction indeed is included in the Bitcoin blockchain) or <em>failure</em> (i.e., the transaction inclusion in the blockchain couldn’t be proved). In the case of <em>success</em>, the return value will be greater than zero, and it will indicate how many confirmations the given block - and transaction - have in the Bridge contract’s Bitcoin blockchain (note that this could differ from other existing - non-blockchain-based, external - Bitcoin nodes, given that update intervals for the Bridge blockchain can be slower). In the case of <em>failure</em>, the return value will be a negative number, and it will show what went wrong. Possible values are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">-1</code>: The block hash given doesn’t exist in the blockchain. This could well be due to the aforementioned delay.</li>
  <li><code class="language-plaintext highlighter-rouge">-2</code>: The block hash corresponds to a block that is not the Bitcoin best chain.</li>
  <li><code class="language-plaintext highlighter-rouge">-4</code>: The block hash given corresponds to a block that is too old to be processed (i.e., its depth with respect to the head of the chain is greater than <code class="language-plaintext highlighter-rouge">4320</code>).</li>
  <li><code class="language-plaintext highlighter-rouge">-5</code>: The given merkle branch fails to prove the inclusion of the given transaction in the given block.</li>
  <li><code class="language-plaintext highlighter-rouge">-3</code>: An inconsistency ocurred that prevented the block from being found. This would occur due to an internal, unexpected problem.</li>
</ul>

<h3 id="merkle-branch">Merkle branch</h3>

<p>A merkle branch is a data structure that serves the purpose of proving the inclusion of a single given transaction in a given block. This data structure takes advantage of the block header merkle root and its underlying merkle tree. In fact, a merkle branch is exactly what its name suggests: a list of intermediate hashes from the leaf (corresponding to the desired transaction) to the merkle root, plus information on the “shape” of the branch itself. This information is precisely what the third and four parameters of the <code class="language-plaintext highlighter-rouge">getBtcTransactionConfirmations</code> method represent. The algorithm to build a merkle branch from a merkle tree is depicted next:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Let tx be the hash of the transaction one wishes to prove inclusion on, and mt the corresponding block's merkle tree.
2. Let height(mt) be the height of a given merkle tree.
3. Let mt[i] be the ith level of the tree, with 0 being the leaf level and height(mt) being the root level (this last of size 1, such that mt[height(mt)][0] is the merkle root).
4. Let then mt[i][j] be the jth node of the ith level of the tree.

5. Let txi be the index such that mt[0][txi] equals tx.
6. Let mbhashes be an empty array; lix = txi; mbpath = 0.
7. With level from 0 to height(mt)-1 do:  
7a.    if lix is even:  
7a1.       mbpath = mbpath + (1 &lt;&lt; (height(mt)-level-1))
7a2.       append mt[level][lix+1] to mbhashes (use mt[level][lix] if lix+1 is out of range)  
7b.    else:  
7b1.       append mt[level][lix-1] to mbhashes
7c.    lix = floor(lix/2)

8. Return (mbhashes, mbpath).
</code></pre></div></div>

<h2 id="references">References</h2>

<p>[1] Simplified Payment Verification https://bitcoin.org/en/operating-modes-guide#simplified-payment-verification-spv</p>

<p>[2] Merkle trees https://en.bitcoin.it/wiki/Protocol_documentation#Merkle_Trees</p>

<p>[3] Bitcoin blockchain guide https://bitcoin.org/en/blockchain-guide#introduction</p>

<h3 id="copyright">Copyright</h3>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer>
    <div class="footer_cont">
        <div class="footer_box">
            <ul class="social-media-list"><li><a href="https://github.com/rsksmart/RSKIPs" target="_blank" rel="noopener"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Visit on Github</span></a></li></ul>
        </div>
    </div>
</footer><script src="../assets/js/dark_mode.js"></script>
    <script src="../../assets/js/dark_mode.js"></script>
  </body>

</html>
