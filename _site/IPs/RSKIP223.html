<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Cumulative Work in Fork Detection Data | RSK Improvement Proposals</title>
    <meta
      property="og:title"
      content="Cumulative Work in Fork Detection Data | RSK Improvement Proposals"
    />
    <meta name="description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />

  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="https://ips.rsk.co/IPs/RSKIP223" />
  <meta property="og:url" content="https://ips.rsk.co/IPs/RSKIP223" />
  <meta property="og:site_name" content="RSK Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "https://ips.rsk.co",
      "name": "RSK Improvement Proposals",
      "description": "RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" />
      <!-- Google Fonts -->
      <link href="https://fonts.googleapis.com/css?family=Quicksand:400,700,900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,600,700,800&display=swap" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="RSK Improvement Proposals" /><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script>
</head>
<body><header class="site-header" role="banner">
  <button id="dark-mode-toggle" class="dark-mode-toggle theme-toggle-button">
    <svg class="icon" style="width:24px;height:24px" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.1L13.73,3.13L12.38,4.26L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.33L10.24,7.36L9.19,8.23L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.93L17.93,10.24C18.6,11.15 19,12.28 19,13.5M14.6,20.08L17.37,18.93L17.13,22.28L14.6,20.08M18.93,17.38L20.08,14.61L22.28,17.15L18.93,17.38M20.08,12.42L18.94,9.64L22.28,9.88L20.08,12.42M9.63,18.93L12.4,20.08L9.87,22.27L9.63,18.93Z" />
    </svg>
  </button>


<div class="wrapper"><a class="site-title" rel="author" href="/">RSK Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link underline" href="/all">All</a><a class="page-link underline" href="/scalability">Scalability</a><a class="page-link underline" href="/security">Security</a><a class="page-link underline" href="/usability">Usability</a><a class="page-link underline" href="/fairness">Fairness</a><a class="page-link underline" href="/standardtrack">Standard Track</a></div>





      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Cumulative Work in Fork Detection Data</h1>
  </header>

  <div class="post-content">
    <h1 id="cumulative-work-in-fork-detection-data">Cumulative Work in Fork Detection Data</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">223</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Cumulative Work in Fork Detection Data</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">31-MAR-2021</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">SDL</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Sec</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">2</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>discussions-to</strong></td>
      <td style="text-align: left">https://research.rsk.dev/t/rskip-223-cumulative-work-in-fork-detection-data/150</td>
    </tr>
  </tbody>
</table>

<h1 id="abstract"><strong>Abstract</strong></h1>

<p>This RSKIP proposes an improvement to the Fork Detection Data present in merge-mining tags (used by the Armadillo Fork Detection System). The tag is extended to include the cumulative work of the chain.</p>

<h1 id="motivation"><strong>Motivation</strong></h1>

<p>The RSK merge-mining tags cointains the following fields:</p>

<ul>
  <li>7-byte Commit-to-Parents-Vector (CPV)</li>
  <li>1-byte number of uncles in the last 32 blocks (NU)</li>
  <li>4-byte Block Number (BN)</li>
</ul>

<p>The last 3 fields are the Fork Detection Data, as specified in <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP110.md">RSKIP110</a>.</p>

<p>The field NU (number of uncles) is used by Armadillo to detect forks containing cumulative work masqueraded as uncle blocks. 
However, is was shown that setting alerts based on this field is difficult because cumulative work has to be guessed.
We propose to extend the merge-mining tag to from 32 bytes to 40 bytes to include a field specifying the cumulative work.
This change not only improves the security against partially hidden forks, but more importantly it provides information about unintended forks. It enables the measurement of the risk that an unintended fork surpasses the honest chain by making the fork cumulative difficulty visible.</p>

<p>This change may impact mining pool softwares which expect a fixed size block hash field from mnr_getWork(). To reduce the need to patch those softwares in a short time, the proposal specifies that after activation both the old and new merge-mining tags can coexists, and we expect that the old format to be phased out in a following hard fork.</p>

<h1 id="specification"><strong>Specification</strong></h1>

<p>The new merge-mining tag format is the following:</p>

<ul>
  <li>PREFIX: 20-byte prefix of the hash-for-merge-mining</li>
  <li>CPV: 7-byte Commit-to-Parents-Vector (CPV)</li>
  <li>NU: 1-byte number of uncles in the last 32 blocks (NU)</li>
  <li>VER_BN4: packed field</li>
  <li>BN:  3-byte Block Number</li>
  <li>CD: 8=byte commulative difficulty (only available in the new tag format)</li>
</ul>

<p>Version 0 represents the old tag format. To enable the new tag-format, version must be set to 1.</p>

<p>the field VER_BN4 contains two nibbles. The hi nibble contains the tag version. Thw low nibble containst the highest 4 bits of the BN field.
CD is specified in units of 2^60 operations.</p>

<p>If the BN field or the CD field overflows, it wraps around zero.</p>

<h1 id="rationale">Rationale</h1>

<p>The granularity of the CD field permits specifying a cumulative difficulty up to 2^124 operations. Currently RSK has a cumulative difficulty of about 2^92 operations, so the cumulative difficulty can still grow 2^32 times without overflow.
The minimum difficulty that can be tracked is 2^60. The current difficulty of an RSK block is about 2^70 operations, which means that the tag format can still be usefull even if the difficulty of the RSK blockchains is reduced 1000 times. 
The BN field space is restricted from 32 to 28 bits, so it will wrap around zero at block 268,435,456. Currently the block number is 3,230,186, which means that the wrap will occur in approximately 254 years. Fork monitoring applications can easily deduce if the field has wrapped and how many times it has based on the Bitcoin block timestamp.</p>

<p>An alternative to this proposal is <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP224.md">RSKIP224</a>. RSKIP224 proposes the re-interpretation the CPV field so that the jumps are considered not over the block numbers, but over the virtual array of blocks and uncles previously referenced. This means that a fork containing many uncles will sooner show a divergence point in the CPV, and therefore cannot be hidden. RSKIP224 provides some of the same benefits of this proposal, but is ortoghonal to it. Both can be combined.</p>

<p>Switching to the new tag format could incentivized by penalizing miners using the old tag format after the activation of this RSKIP. For example, they could  receive only 50% ofthe rewards paid by the REMASC contract. This should be specified in another RSKIP.</p>

<h1 id="backwards-compatibility">Backwards Compatibility</h1>

<p>This change is a hard-fork and therefore all full nodes must be updated. SPV light-clients and Block explorers that are always in sync do not need to be updated.</p>

<h1 id="test-cases">Test Cases</h1>

<p>TBD</p>

<h2 id="security-considerations">Security Considerations</h2>

<p>This cumulative difficulty present in the new tag should not be used alone to trigger an alert. A malicious minority miner can lie and create an RSK merge-mining tag with false data pretending the existence of a hidden fork of arbitrary high difficulty. The miner considered in this attack is not participating in RSK merge-mining (as his blocks are invalid) but only tries to disrupt the RSK network. Therefore nodes must use the cumulative difficulty information together with the detection of other merge-mining blocks (linked to the fork using the CPV field) to estimate the real hashrate pariticpating in the malicious fork.
The new field does allow nodes to dismiss an unintended fork created by single RSK miner in isolation. If the miner has substancial but not the majority of the hasrate, the fork may look risky because of its length, but it is not so because it doesnâ€™t collect the difficulty of uncles produced by the rest of the network.</p>

<h1 id="copyright"><strong>Copyright</strong></h1>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer>
    <div class="footer_cont">
        <div class="footer_box">
            <ul class="social-media-list"><li><a href="https://github.com/rsksmart/RSKIPs" target="_blank" rel="noopener"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Visit on Github</span></a></li></ul>
        </div>
    </div>
</footer><script src="../assets/js/dark_mode.js"></script>
    <script src="../../assets/js/dark_mode.js"></script>
  </body>

</html>
